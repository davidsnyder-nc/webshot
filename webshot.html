<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Screenshot Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .preview-iframe {
            width: 100%;
            height: 100%;
            border: 0;
            background-color: #f8fafc;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .active-tab {
            border-color: #3b82f6;
            color: #ffffff;
        }
        .iframe-wrapper {
             transition: all 0.3s ease-in-out;
             position: relative;
        }
        .action-btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-slate-300">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Responsive Screenshot Generator</h1>
            <p class="mt-2 text-slate-400">A simple tool for previewing and capturing websites.</p>
        </header>

        <!-- Step 1: URL Input Section -->
        <div id="step1-section" class="max-w-3xl mx-auto mb-8 space-y-4">
            <h2 class="text-xl font-semibold text-center text-slate-200">Step 1: Load a Website</h2>
            <div class="flex flex-col sm:flex-row gap-2 items-center">
                <input type="text" id="urlInput" placeholder="https://example.com or a public ngrok URL" class="flex-grow w-full px-4 py-3 bg-slate-800 border border-slate-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                <button id="loadUrlBtn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all transform hover:scale-105 flex-shrink-0">
                    Load Preview
                </button>
            </div>
            <div class="pt-4">
                <details class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <summary class="font-medium text-slate-200">Need to screenshot a local website?</summary>
                    <div class="mt-3 text-sm text-slate-400 space-y-2">
                        <p>You can't use a `localhost` address directly. You need a free tool called <a href="https://ngrok.com/download" target="_blank" class="text-blue-400 hover:underline">ngrok</a> to create a temporary public URL for your local server.</p>
                        <ol class="list-decimal list-inside space-y-1 pl-2">
                            <li>Open a new terminal window (don't close your running local server).</li>
                            <li>Navigate to where you downloaded ngrok.</li>
                            <li>Run the command: <code class="bg-slate-700 text-slate-200 px-1 py-0.5 rounded">./ngrok http YOUR_PORT_NUMBER</code> (e.g., `./ngrok http 8000`).</li>
                            <li>Copy the public `https://...ngrok-free.app` URL it gives you.</li>
                            <li>Paste that ngrok URL into the input box above.</li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <!-- Settings Button to re-open Step 1 -->
        <div id="settings-section" class="text-center mb-8 hidden">
            <button id="settingsBtn" class="px-5 py-2 bg-slate-700 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all">
                Load New URL
            </button>
        </div>

        <!-- Step 2: API Options -->
        <div id="step2-section" class="max-w-3xl mx-auto my-8 space-y-4 hidden">
            <h2 class="text-xl font-semibold text-center text-slate-200">Step 2: Generate Screenshots</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                <div>
                    <label for="apiProvider" class="block text-sm font-medium text-slate-300 mb-1">Screenshot Service</label>
                    <select id="apiProvider" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="apiflash" selected>APIFlash</option>
                        <option value="screenshotone">ScreenshotOne</option>
                    </select>
                </div>
                 <div>
                    <label for="apiKeyInput" class="block text-sm font-medium text-slate-300 mb-1">API Key</label>
                    <input type="text" id="apiKeyInput" placeholder="Enter key for selected service" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
             <div class="text-center">
                <button id="generateBtn" class="action-btn w-full sm:w-auto px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all text-lg">
                    Generate All Screenshots
                </button>
                <p class="mt-1 text-xs text-slate-500">Get a free key from <a href="https://screenshotone.com" target="_blank" class="text-blue-400 hover:underline">ScreenshotOne</a> or <a href="https://apiflash.com" target="_blank" class="text-blue-400 hover:underline">APIFlash</a>.</p>
             </div>
            <p id="error-message" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
        
        <!-- Preview Section with Tabs -->
        <div id="preview-section" class="hidden">
            <!-- Tabs Navigation -->
            <div class="border-b border-slate-700 mb-6">
                <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                    <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500" data-target="phone-preview-panel">
                        Phone
                    </button>
                    <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500" data-target="tablet-preview-panel">
                        Tablet
                    </button>
                    <button class="tab-btn active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="desktop-preview-panel">
                        Desktop
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Phone Preview Panel -->
                <div id="phone-preview-panel" class="preview-panel hidden">
                    <div class="flex justify-center items-center flex-col">
                        <div class="w-full max-w-sm flex justify-center items-center space-x-4 mb-4">
                             <button class="rotate-btn text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors" data-device="phone">Rotate</button>
                             <a class="download-link hidden action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="phone">Download Image</a>
                        </div>
                        <div id="phone-iframe-wrapper" class="iframe-wrapper w-[375px] h-[667px] mx-auto border-4 border-neutral-800 rounded-3xl overflow-hidden shadow-2xl bg-white" data-orientation="portrait">
                        </div>
                    </div>
                </div>

                <!-- Tablet Preview Panel -->
                <div id="tablet-preview-panel" class="preview-panel hidden">
                    <div class="flex justify-center items-center flex-col">
                         <div class="w-full max-w-4xl flex justify-center items-center space-x-4 mb-4">
                            <button class="rotate-btn text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors" data-device="tablet">Rotate</button>
                            <a class="download-link hidden action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="tablet">Download Image</a>
                        </div>
                        <div id="tablet-iframe-wrapper" class="iframe-wrapper w-[768px] h-[1024px] mx-auto border-4 border-neutral-800 rounded-3xl overflow-hidden shadow-2xl bg-white" data-orientation="portrait">
                        </div>
                    </div>
                </div>

                <!-- Desktop Preview Panel -->
                <div id="desktop-preview-panel" class="preview-panel">
                     <div class="flex justify-center items-center flex-col">
                        <div class="w-full max-w-6xl flex justify-center items-center space-x-4 mb-4">
                            <a class="download-link hidden action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="desktop">Download Image</a>
                        </div>
                        <div id="desktop-iframe-wrapper" class="iframe-wrapper w-[1280px] h-[864px] mx-auto border-4 border-neutral-800 rounded-xl overflow-hidden shadow-2xl bg-white" data-orientation="landscape">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Initial Message -->
        <div id="initial-message" class="text-center py-24">
            <p class="text-slate-400 text-lg">Enter a URL to start.</p>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const urlInput = document.getElementById('urlInput');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiProviderSelect = document.getElementById('apiProvider');
        const generateBtn = document.getElementById('generateBtn');
        const errorMessage = document.getElementById('error-message');
        
        const step1Section = document.getElementById('step1-section');
        const step2Section = document.getElementById('step2-section');
        const settingsSection = document.getElementById('settings-section');
        const settingsBtn = document.getElementById('settingsBtn');

        const previewSection = document.getElementById('preview-section');
        const initialMessage = document.getElementById('initial-message');
        
        const rotateButtons = document.querySelectorAll('.rotate-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.preview-panel');
        let currentLoadedContent = null;

        // --- Event Listeners ---
        loadUrlBtn.addEventListener('click', handleLoadUrl);
        generateBtn.addEventListener('click', handleGenerateScreenshots);

        settingsBtn.addEventListener('click', () => {
            step1Section.classList.remove('hidden');
            step2Section.classList.add('hidden');
            settingsSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            initialMessage.classList.remove('hidden');
        });

        apiProviderSelect.addEventListener('change', () => {
            loadKeysFromStorage();
        });

        apiKeyInput.addEventListener('input', () => {
            const selectedProvider = apiProviderSelect.value;
            localStorage.setItem(`${selectedProvider}_key`, apiKeyInput.value);
        });
        
        rotateButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const deviceName = button.getAttribute('data-device');
                const elementToRotate = document.getElementById(`${deviceName}-iframe-wrapper`);
                if (elementToRotate) {
                    const currentOrientation = elementToRotate.dataset.orientation;
                    elementToRotate.dataset.orientation = currentOrientation === 'portrait' ? 'landscape' : 'portrait';
                    const currentWidth = elementToRotate.offsetWidth;
                    const currentHeight = elementToRotate.offsetHeight;
                    elementToRotate.style.width = `${currentHeight}px`;
                    elementToRotate.style.height = `${currentWidth}px`;
                }
            });
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');
                tabPanels.forEach(panel => panel.classList.add('hidden'));
                const targetPanel = document.getElementById(button.getAttribute('data-target'));
                if(targetPanel) targetPanel.classList.remove('hidden');
            });
        });

        // --- Functions ---
        function loadKeysFromStorage() {
            const selectedProvider = apiProviderSelect.value;
            const storedKey = localStorage.getItem(`${selectedProvider}_key`);
            apiKeyInput.value = storedKey || '';
        }

        function handleLoadUrl() {
            let url = urlInput.value.trim();
            errorMessage.textContent = '';
            if (!url) { errorMessage.textContent = 'Please enter a URL.'; return; }
            if (!url.startsWith('http://') && !url.startsWith('https://')) { url = 'https://' + url; urlInput.value = url; }
            try { new URL(url); } catch (_) { errorMessage.textContent = 'Please enter a valid URL.'; return; }
            
            currentLoadedContent = { type: 'url', value: url, name: new URL(url).hostname };
            loadContent(currentLoadedContent);
        }
        
        function loadContent(content) {
            initialMessage.classList.add('hidden');
            step1Section.classList.add('hidden');
            settingsSection.classList.remove('hidden');
            previewSection.classList.remove('hidden');
            step2Section.classList.remove('hidden');

            ['phone', 'tablet', 'desktop'].forEach(device => {
                const wrapper = document.getElementById(`${device}-iframe-wrapper`);
                wrapper.innerHTML = `<iframe id="${device}-iframe" class="preview-iframe" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>`;
                const iframe = document.getElementById(`${device}-iframe`);
                iframe.src = content.value;
                document.querySelector(`.download-link[data-device="${device}"]`).classList.add('hidden');
            });
        }
        
        async function handleGenerateScreenshots() {
            const apiKey = apiKeyInput.value.trim();
            const urlToCapture = currentLoadedContent?.value;
            const apiProvider = apiProviderSelect.value;
            errorMessage.textContent = '';

            if (!apiKey) { errorMessage.textContent = `Please enter your ${apiProvider} API key.`; apiKeyInput.focus(); return; }
            if (!urlToCapture) { errorMessage.textContent = 'A valid URL is required to generate screenshots.'; return; }
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            const generatedLinks = [];

            const screenshotPromises = ['phone', 'tablet', 'desktop'].map(async (device) => {
                const result = await generateSingleScreenshot(device, apiKey, urlToCapture, apiProvider);
                if (result) {
                    generatedLinks.push(result);
                }
            });

            await Promise.all(screenshotPromises);

            generatedLinks.forEach((link, index) => {
                setTimeout(() => {
                    link.click();
                }, index * 350); // Stagger downloads slightly
            });

            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate All Screenshots';
        }

        async function generateSingleScreenshot(deviceName, apiKey, urlToCapture, apiProvider) {
            const wrapper = document.getElementById(`${deviceName}-iframe-wrapper`);
            const downloadLink = document.querySelector(`.download-link[data-device="${deviceName}"]`);
            wrapper.innerHTML = '<div class="w-full h-full flex items-center justify-center"><div class="loader"></div></div>';
            
            const orientation = wrapper.dataset.orientation;
            const dimensions = { phone: { width: 375, height: 667 }, tablet: { width: 768, height: 1024 }, desktop: { width: 1280, height: 864 } };
            let [viewportWidth, viewportHeight] = [dimensions[deviceName].width, dimensions[deviceName].height];
            if (orientation === 'landscape' && deviceName !== 'desktop') { [viewportWidth, viewportHeight] = [viewportHeight, viewportWidth]; }

            let apiUrl;
            if (apiProvider === 'screenshotone') {
                apiUrl = new URL('https://api.screenshotone.com/take');
                apiUrl.searchParams.set('access_key', apiKey);
                apiUrl.searchParams.set('device_scale_factor', 2);
                apiUrl.searchParams.set('block_ads', true);
                apiUrl.searchParams.set('block_cookie_banners', true);
            } else {
                apiUrl = new URL('https://api.apiflash.com/v1/urltoimage');
                apiUrl.searchParams.set('access_key', apiKey);
                apiUrl.searchParams.set('scale_factor', 2);
                apiUrl.searchParams.set('no_ads', true);
                apiUrl.searchParams.set('no_cookie_banners', true);
            }
            apiUrl.searchParams.set('url', urlToCapture);
            apiUrl.searchParams.set(apiProvider === 'screenshotone' ? 'viewport_width' : 'width', viewportWidth);
            apiUrl.searchParams.set(apiProvider === 'screenshotone' ? 'viewport_height' : 'height', viewportHeight);
            
            if (urlToCapture.includes('ngrok-free.app')) {
                 if (apiProvider === 'screenshotone') {
                    apiUrl.searchParams.set('headers', 'ngrok-skip-browser-warning:true');
                } else if (apiProvider === 'apiflash') {
                    apiUrl.searchParams.set('custom_headers', '{"ngrok-skip-browser-warning":"true"}');
                }
            }
            
            try {
                const response = await fetch(apiUrl.toString());
                if (!response.ok) { throw new Error(`API request failed: ${response.statusText}`); }
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                wrapper.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover" alt="${deviceName} screenshot">`;
                const filename = `${deviceName}-${orientation}-${currentLoadedContent.name}.png`;
                downloadLink.href = imageUrl;
                downloadLink.download = filename;
                downloadLink.classList.remove('hidden');
                return downloadLink; // Return the link for auto-download
            } catch (error) {
                wrapper.innerHTML = `<div class="p-4 text-center text-red-500">Failed. Error: ${error.message}</div>`;
                return null;
            }
        }

        // --- Initialization ---
        loadKeysFromStorage();
    </script>
</body>
</html>
