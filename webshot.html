<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebShot - Responsive Screenshot Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .preview-iframe, .screenshot-img {
            width: 100%;
            height: 100%;
            border: 0;
            background-color: #f8fafc;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .active-tab {
            border-color: #3b82f6;
            color: #ffffff !important;
        }
        .action-btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            cursor: pointer;
        }

        /* --- Device Frames --- */
        .device-frame {
            position: relative;
            background: #1f2937;
            border: 4px solid #374151;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            transition: all 0.3s ease-in-out;
            overflow: hidden; 
        }
        .phone-frame {
            border-width: 12px;
            border-radius: 40px;
        }
        .phone-frame .device-screen {
            border-radius: 28px;
        }
        .phone-frame::before {
            content: '';
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 20px;
            background: #1f2937;
            border-radius: 0 0 10px 10px;
            z-index: 10;
        }
        .tablet-frame {
            border-width: 16px;
            border-radius: 24px;
        }
         .tablet-frame .device-screen {
            border-radius: 8px;
        }
        .desktop-frame {
            border-width: 16px;
            border-radius: 12px;
            padding-top: 24px;
            background: #1f2937;
        }
        .desktop-frame::before { /* Camera */
             content: '';
             position: absolute;
             top: 8px;
             left: 50%;
             transform: translateX(-50%);
             width: 6px;
             height: 6px;
             background: #4b5563;
             border-radius: 50%;
        }
         .desktop-frame .device-screen {
            border-radius: 1px;
        }
        .desktop-frame::after { /* Stand */
            content: '';
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 50px;
            background: #1f2937;
            clip-path: polygon(20% 0, 80% 0, 100% 100%, 0% 100%);
        }
        .device-screen {
            background: #fff;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-slate-300">

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div id="settings-modal-content" class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-white">Settings</h2>
                 <button id="closeSettingsBtn" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
             <div class="space-y-4">
                <div>
                    <label for="apiProvider" class="block text-sm font-medium text-slate-300 mb-1">Default Screenshot Service</label>
                    <select id="apiProvider" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="apiflash">APIFlash</option>
                        <option value="screenshotone">ScreenshotOne</option>
                    </select>
                </div>
                 <div>
                    <label for="apiKeyInput" class="block text-sm font-medium text-slate-300 mb-1">API Key for Selected Service</label>
                    <input type="text" id="apiKeyInput" placeholder="Enter key for selected service" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
             </div>
             <div class="pt-2">
                <details class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <summary class="font-medium text-slate-200">Need to screenshot a local website?</summary>
                    <div class="mt-3 text-sm text-slate-400 space-y-2">
                        <p>You can't use a `localhost` address directly. You need a free tool called <a href="https://ngrok.com/download" target="_blank" class="text-blue-400 hover:underline">ngrok</a> to create a temporary public URL.</p>
                        <ol class="list-decimal list-inside space-y-2 pl-2">
                            <li>Open a terminal and run:<br><code class="bg-slate-600 text-slate-200 px-1 py-0.5 rounded text-xs">./ngrok http YOUR_PORT --host-header="localhost:YOUR_PORT"</code></li>
                            <li>Copy the public `https://...ngrok-free.app` URL and paste it in the main URL input box.</li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header id="main-header" class="text-center mb-8">
            <div class="flex justify-center items-center gap-4">
                <h1 class="text-3xl md:text-4xl font-bold text-white">WebShot</h1>
                <button id="refreshBtn" class="text-slate-400 hover:text-white" title="Refresh">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>
                <button id="openSettingsBtn" class="text-slate-400 hover:text-white" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <!-- URL Input & Generate Section -->
        <div id="controls-section" class="max-w-3xl mx-auto mb-8 space-y-4">
             <div class="flex flex-col sm:flex-row gap-2 items-center">
                <input type="text" id="urlInput" placeholder="https://example.com or a public ngrok URL" class="flex-grow w-full px-4 py-3 bg-slate-800 border border-slate-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" list="urlHistory">
                 <datalist id="urlHistory"></datalist>
                <button id="loadUrlBtn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all transform hover:scale-105 flex-shrink-0">
                    Load Preview
                </button>
            </div>
             <div class="flex justify-end items-center -mt-2 pr-2">
                <button id="clearHistoryBtn" class="text-xs text-slate-500 hover:text-red-500 hover:underline">Clear History</button>
            </div>
            <p id="error-message" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
        
        <!-- Preview Section with Tabs -->
        <div id="preview-section" class="hidden">
            <!-- Tabs Navigation -->
            <div class="border-b border-slate-700 mb-6">
                <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                    <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500" data-target="phone-preview-panel">Phone</button>
                    <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500" data-target="tablet-preview-panel">Tablet</button>
                    <button class="tab-btn active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="desktop-preview-panel">Desktop</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                 <!-- Phone Preview Panel -->
                <div id="phone-preview-panel" class="preview-panel hidden">
                    <div class="flex justify-center items-center flex-col" style="padding-bottom: 30px;">
                        <div class="w-full max-w-sm flex justify-center items-center space-x-4 mb-4">
                             <button class="rotate-btn text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors" data-device="phone">Rotate</button>
                             <button class="popout-btn action-btn text-sm bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" data-device="phone">Pop-out</button>
                             <button class="generate-btn action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="phone">Generate API Image</button>
                             <a class="download-link hidden action-btn text-sm bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600" data-device="phone">Download</a>
                        </div>
                        <div data-device="phone" class="device-frame phone-frame" style="width: 375px; height: 667px;" data-orientation="portrait">
                           <div id="phone-iframe-wrapper" class="device-screen overflow-hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Tablet Preview Panel -->
                <div id="tablet-preview-panel" class="preview-panel hidden">
                    <div class="flex justify-center items-center flex-col" style="padding-bottom: 30px;">
                         <div class="w-full max-w-4xl flex justify-center items-center space-x-4 mb-4">
                            <button class="rotate-btn text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors" data-device="tablet">Rotate</button>
                            <button class="popout-btn action-btn text-sm bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" data-device="tablet">Pop-out</button>
                            <button class="generate-btn action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="tablet">Generate API Image</button>
                            <a class="download-link hidden action-btn text-sm bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600" data-device="tablet">Download</a>
                        </div>
                        <div data-device="tablet" class="device-frame tablet-frame" style="width: 768px; height: 1024px;" data-orientation="portrait">
                            <div id="tablet-iframe-wrapper" class="device-screen overflow-hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Desktop Preview Panel -->
                <div id="desktop-preview-panel" class="preview-panel">
                     <div class="flex justify-center items-center flex-col" style="padding-bottom: 80px;">
                        <div class="w-full max-w-6xl flex justify-center items-center space-x-4 mb-4">
                            <button class="popout-btn action-btn text-sm bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" data-device="desktop">Pop-out</button>
                            <button class="generate-btn action-btn text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-device="desktop">Generate API Image</button>
                            <a class="download-link hidden action-btn text-sm bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600" data-device="desktop">Download</a>
                        </div>
                        <div data-device="desktop" class="device-frame desktop-frame" style="width: 1280px; height: 720px;" data-orientation="landscape">
                            <div id="desktop-iframe-wrapper" class="device-screen overflow-hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const urlInput = document.getElementById('urlInput');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiProviderSelect = document.getElementById('apiProvider');
        const errorMessage = document.getElementById('error-message');
        const urlHistoryDatalist = document.getElementById('urlHistory');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        
        const controlsSection = document.getElementById('controls-section');
        
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const refreshBtn = document.getElementById('refreshBtn');

        const previewSection = document.getElementById('preview-section');
        
        const rotateButtons = document.querySelectorAll('.rotate-btn');
        const popoutButtons = document.querySelectorAll('.popout-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.preview-panel');
        let currentLoadedContent = null;

        // --- Event Listeners ---
        loadUrlBtn.addEventListener('click', handleLoadUrl);
        document.querySelectorAll('.generate-btn').forEach(btn => btn.addEventListener('click', handleGenerateScreenshot));
        clearHistoryBtn.addEventListener('click', clearUrlHistory);
        
        openSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        refreshBtn.addEventListener('click', () => location.reload());
        closeSettingsBtn.addEventListener('click', closeAndSaveSettings);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeAndSaveSettings();
            }
        });

        apiProviderSelect.addEventListener('change', () => loadKeysFromStorage());
        apiKeyInput.addEventListener('input', () => {
            const selectedProvider = apiProviderSelect.value;
            localStorage.setItem(`${selectedProvider}_key`, apiKeyInput.value);
        });
        
        rotateButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const deviceName = button.getAttribute('data-device');
                const elementToRotate = document.querySelector(`.device-frame[data-device="${deviceName}"]`);
                if (elementToRotate) {
                    const currentOrientation = elementToRotate.dataset.orientation;
                    elementToRotate.dataset.orientation = currentOrientation === 'portrait' ? 'landscape' : 'portrait';
                    const currentWidth = elementToRotate.style.width;
                    const currentHeight = elementToRotate.style.height;
                    elementToRotate.style.width = currentHeight;
                    elementToRotate.style.height = currentWidth;
                }
            });
        });
        
        popoutButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const deviceName = e.target.dataset.device;
                const popoutUrl = currentLoadedContent?.value; 
                if (popoutUrl) {
                    const frame = document.querySelector(`.device-frame[data-device="${deviceName}"]`);
                    const orientation = frame.dataset.orientation;
                    const dimensions = { phone: { width: 375, height: 667 }, tablet: { width: 768, height: 1024 }, desktop: { width: 1280, height: 720 } };
                    let [width, height] = [dimensions[deviceName].width, dimensions[deviceName].height];
                    if (orientation === 'landscape' && deviceName !== 'desktop') {
                        [width, height] = [height, width];
                    }
                    window.open(popoutUrl, '_blank', `width=${width},height=${height},scrollbars=yes,resizable=yes`);
                }
            });
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');
                tabPanels.forEach(panel => panel.classList.add('hidden'));
                const targetPanel = document.getElementById(button.getAttribute('data-target'));
                if(targetPanel) targetPanel.classList.remove('hidden');
            });
        });
        
        // --- Functions ---
        function closeAndSaveSettings() {
             localStorage.setItem('webshot_default_provider', apiProviderSelect.value);
             settingsModal.classList.add('hidden');
        }

        function loadKeysFromStorage() {
            const defaultProvider = localStorage.getItem('webshot_default_provider');
            if(defaultProvider) apiProviderSelect.value = defaultProvider;

            const selectedProvider = apiProviderSelect.value;
            const storedKey = localStorage.getItem(`${selectedProvider}_key`);
            apiKeyInput.value = storedKey || '';
        }

        function loadUrlHistory() {
            const history = JSON.parse(localStorage.getItem('webshot_history') || '[]');
            urlHistoryDatalist.innerHTML = '';
            history.forEach(url => {
                const option = document.createElement('option');
                option.value = url;
                urlHistoryDatalist.appendChild(option);
            });
        }

        function saveUrlToHistory(url) {
            let history = JSON.parse(localStorage.getItem('webshot_history') || '[]');
            if (!history.includes(url)) {
                history.unshift(url);
                history = history.slice(0, 10);
                localStorage.setItem('webshot_history', JSON.stringify(history));
                loadUrlHistory();
            }
        }
        
        function clearUrlHistory() {
            localStorage.removeItem('webshot_history');
            loadUrlHistory();
            urlInput.value = '';
        }

        function handleLoadUrl() {
            let url = urlInput.value.trim();
            errorMessage.textContent = '';
            if (!url) { errorMessage.textContent = 'Please enter a URL.'; return; }
            if (!url.startsWith('http://') && !url.startsWith('https://')) { url = 'https://' + url; urlInput.value = url; }
            try { new URL(url); } catch (_) { errorMessage.textContent = 'Please enter a valid URL.'; return; }
            
            saveUrlToHistory(url);
            currentLoadedContent = { type: 'url', value: url, name: new URL(url).hostname };
            loadContent(currentLoadedContent);
        }
        
        function loadContent(content) {
            previewSection.classList.remove('hidden');
            controlsSection.classList.remove('hidden');
            document.getElementById('main-header').classList.remove('hidden');

            ['phone', 'tablet', 'desktop'].forEach(device => {
                const wrapper = document.getElementById(`${device}-iframe-wrapper`);
                wrapper.innerHTML = `<iframe id="${device}-iframe" class="preview-iframe" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>`;
                const iframe = document.getElementById(`${device}-iframe`);
                iframe.src = content.value;
                document.querySelector(`.download-link[data-device="${device}"]`).classList.add('hidden');
                document.querySelector(`.popout-btn[data-device="${device}"]`).classList.remove('hidden');
                document.querySelector(`.generate-btn[data-device="${device}"]`).classList.remove('hidden');
            });
        }
        
        async function handleGenerateScreenshot(e) {
            const deviceName = e.target.dataset.device;
            localStorage.setItem('webshot_default_provider', apiProviderSelect.value);
            const apiKey = apiKeyInput.value.trim();
            const urlToCapture = currentLoadedContent?.value;
            const apiProvider = apiProviderSelect.value;
            errorMessage.textContent = '';

            if (!apiKey) { errorMessage.textContent = `Please set your API key in Settings.`; openSettingsBtn.click(); return; }
            if (!urlToCapture) { errorMessage.textContent = 'A valid URL is required.'; return; }
            
            const button = e.target;
            button.disabled = true;
            button.textContent = 'Generating...';

            await generateSingleScreenshot(deviceName, apiKey, urlToCapture, apiProvider);
            
            button.disabled = false;
            button.textContent = 'Generate API Image';
        }

        async function generateSingleScreenshot(deviceName, apiKey, urlToCapture, apiProvider) {
            const frame = document.querySelector(`.device-frame[data-device="${deviceName}"]`);
            const wrapper = document.getElementById(`${deviceName}-iframe-wrapper`);
            const downloadLink = document.querySelector(`.download-link[data-device="${deviceName}"]`);
            wrapper.innerHTML = '<div class="w-full h-full flex items-center justify-center"><div class="loader"></div></div>';
            
            const orientation = frame.dataset.orientation;
            const dimensions = { phone: { width: 375, height: 667 }, tablet: { width: 768, height: 1024 }, desktop: { width: 1280, height: 720 } };
            let [viewportWidth, viewportHeight] = [dimensions[deviceName].width, dimensions[deviceName].height];
            if (orientation === 'landscape' && deviceName !== 'desktop') { [viewportWidth, viewportHeight] = [viewportHeight, viewportWidth]; }

            let apiUrl;
            if (apiProvider === 'screenshotone') {
                apiUrl = new URL('https://api.screenshotone.com/take');
                apiUrl.searchParams.set('access_key', apiKey);
                apiUrl.searchParams.set('device_scale_factor', 2);
                apiUrl.searchParams.set('block_ads', true);
                apiUrl.searchParams.set('block_cookie_banners', true);
            } else {
                apiUrl = new URL('https://api.apiflash.com/v1/urltoimage');
                apiUrl.searchParams.set('access_key', apiKey);
                apiUrl.searchParams.set('scale_factor', 2);
                apiUrl.searchParams.set('no_ads', true);
                apiUrl.searchParams.set('no_cookie_banners', true);
            }
            apiUrl.searchParams.set('url', urlToCapture);
            apiUrl.searchParams.set(apiProvider === 'screenshotone' ? 'viewport_width' : 'width', viewportWidth);
            apiUrl.searchParams.set(apiProvider === 'screenshotone' ? 'viewport_height' : 'height', viewportHeight);
            
            if (urlToCapture.includes('ngrok-free.app')) {
                 if (apiProvider === 'screenshotone') {
                    apiUrl.searchParams.set('headers', 'ngrok-skip-browser-warning:true');
                } else if (apiProvider === 'apiflash') {
                    apiUrl.searchParams.set('custom_headers', '{"ngrok-skip-browser-warning":"true"}');
                }
            }
            
            try {
                const response = await fetch(apiUrl.toString());
                if (!response.ok) { throw new Error(`API request failed: ${response.statusText}`); }
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                wrapper.innerHTML = `<img src="${imageUrl}" class="screenshot-img" alt="${deviceName} screenshot">`;
                const filename = `${deviceName}-${orientation}-${currentLoadedContent.name}.png`;
                downloadLink.href = imageUrl;
                downloadLink.download = filename;
                downloadLink.classList.remove('hidden');
                document.querySelector(`.generate-btn[data-device="${deviceName}"]`).classList.add('hidden');
                return downloadLink;
            } catch (error) {
                wrapper.innerHTML = `<div class="p-4 text-center text-red-500">Failed. Error: ${error.message}</div>`;
                return null;
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadKeysFromStorage();
            loadUrlHistory();
        });
    </script>
</body>
</html>
